#!/bin/bash

# BEGIN-INCLUDE LICENSE-header
# END-INCLUDE

export SHXMLSHARE SHXMLBINARY SHXMLCOMMANDS
SHXMLBINARY="$(basename "$0")"
SHXMLSHARE="$(dirname "$(readlink -f "$0")")/.."
declare -a SHXMLCOMMANDS
source "$SHXMLSHARE/lib/common.bash"
while read -r cmd;do SHXMLCOMMANDS+=("$cmd");done < <(compgen -c "$SHXMLBINARY-")

usage() {
    local error cmd synopses
    if [[ ! -z "$1" ]];then
        error="\n!!\n!! $1 !!\n!!\n"
    fi
    synopses="\n\n"
    for cmd in "${SHXMLCOMMANDS[@]}";do
        synopses+="        ${cmd#$SHXMLBINARY-}\t- $($cmd --synopsis)\n"
    done
    echo -e "$SHXMLBINARY <command> [options] <arguments>
    $error
    Commands:$synopses
    Run '$SHXMLBINARY <command> --help to get command-specific help"
}

## ## OPTIONS
##
parse_options() {
    while [[ "$1" = -?* ]];do
        case "$1" in
            ## ### -h, --help
            ##
            ## Show help
            ##
            -h|--help) usage ""; exit ;;
            *) usage "Unknown option '$1'"; exit 1 ;;
        esac
        shift
    done
}

parse_command() {
    if [[ -z "$1" ]];then
        usage ""
        exit
    fi
    local cmd="$SHXMLBINARY-$1"
    if ! compgen -c "$cmd" >/dev/null;then
        usage "No such command: '$1'"
        exit 140
    fi
    shift
    exec "$cmd" "$@"
}

parse_options "$@"
parse_command "$@"
